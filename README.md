# European XFEL User Environments

This repository contains Conda environment specifications and lock files
defining the environments provided for users at EuXFEL.

All environments contain **only** Conda packages, as installing packages via pip
into a Conda environment leads to inconsistencies.

If a package is not packaged on Conda, then a recipe should be created for
it, either by hand or via a tool like Grayskull.

## Environments

An environment is created per European XFEL experiment cycle, this is done
so that previous environments are preserved for reproducibility. The files
defining the environments are stored `./environments/${CYCLE}`.

Each environment directory will have two or three files:

- `base.yaml` - Conda environment file containing packages which are
  available on a Conda channel
- `custom.yaml` - optional Conda environment file containing packages built
  from custom recipes (see [Custom Recipes](#custom-recipes))
- `conda-lock.yaml` - file generated by `conda-lock` using the environment
  files as inputs

### Creating a New Environments

### Modifying Existing Environments

## Custom Recipes

If a package does not already have a Conda recipe and is only available
on PyPI or via a repository URL, then a recipe should be made for it to
allow for installation into the Conda environments.

Creation of the recipes can be automated via [Grayskull](https://github.com/conda-incubator/grayskull),
which attempt to convert the package setup to a Conda recipe, and
implement some basic testing as part of the build phase (check that
importing the package works, tests that entry points work), and also
run [conda-verify](https://github.com/conda/conda-verify) to
check package correctness.

Once a recipe has been created, the package must be built and added
to a directory that the relevant environment indexes. This can be done
with `conda mambabuild ...` (more info in next section), which will
attempt to build the package and execute any tests that are included
in the recipe.

If Grayskull fails to create a valid recipe, then the Conda documentation
on creating recipes should be checked.

### Creating a Recipe

Recipes can be created via the Grayskull CLI:

```sh
grayskull pypi --recursive ${PYPI_NAME_OR_URL}
```

The `--recursive` flag is used to tell Grayskull to generate recipes
for any dependencies of the package which are also not in a Conda channel.

### Building a Package

Once a new recipe is created, it must be built to create an installable
package.

If the Conda installation the package is being built for is new, you
will have to tell it to use the build target directory as a channel, so
that any packages you have built will be installable.

```sh
conda config --add channels ${BUILD_DIRECTORY}
conda index ${BUILD_DIRECTORY}
```

As it provides much faster performance, Boa (`mambabuild`) is
used for the build process:

```sh
conda mambabuild \
  --skip-existing \  # Do not re-build already built packages
  --python 3.9 \  # Set python version for build
  --numpy 1.23 \  # Set numpy version for build
  --no-anaconda-upload \  # Do not attempt to upload package
  -c file://${BUILD_DIRECTORY} \  # Build target directory
  --use-local ${RECIPE_DIRECTORY}  # Recipe directory
```

If the build runs successfully, then the package will be placed into
the build directory, and it will be installable by the Conda instance
as the directory is an indexed channel.

If the build was not successful, then the package should be moved out
of the `recipes` directory, and can be added to a `broken` directory
while it is being fixed. If this is not done then future builds will
fail as they the Conda build process builds **all** recipes in the
directory, not just a single package.
