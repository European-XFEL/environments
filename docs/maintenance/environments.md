# Environments

This repository is stored in the directory `/gpfs/exfel/sw/software/euxfel-environment-management` on Maxwell.

An environment is created per European XFEL experiment cycle, this is done so that previous environments are preserved for reproducibility. The files defining the environments are stored `./environments/${CYCLE}` (note: `./` refers to **this git repository**, not the GPFS software directory).

Each environment directory will have a few files:

- `0-desy-pinned.yml` - environment file with a few packages that we should keep in sync with DESY, e.g. if we have a different version of `ipympl` (interactive plotting backend for matplotlib) to the one in the DESY Conda environment that is running Max-JHub then there may be problems with interactive plotting due to incompatibilities.
- `1-base.yml` - Conda environment file containing packages which are available on a Conda channel
- `2-custom.yml` - optional Conda environment file containing packages built from custom recipes (see [Recipes](./recipes.md))
- `environment.yml` - file generated by merging the three files from above into one
- `environment.lock.yml` - the output of `conda env export`, contains the versions of all packages installed in the environment

Environments exist in an installation of Conda, setting up a new Conda installation is very rarely required and is covered in the [Instances](./instances.md) section.

## Environment Specification Setup

### Creating New Specifications

The first step to creating a new environment is activating an installation, this can be done with `module load exfel mambaforge`. Loading this module will initialise the Conda instance into the `base` environment which provides useful tools for environment management.

Once a Conda instance has been activated, you can create a new directory under either `./environments/${CYCLE}` or `./applications/${APPLICATION_NAME}/{APPLICATION_VERSION}` depending on whether the environment is intended to be a generic environment users will activate to write and execute their own code, or if the environment exists only to provide a specific application.

If a new **cycle environment** is being created, copy the `0-desy-pinned.yml`, `1-base.yml`, and `2-custom.yml` files from the previous cycle and use those as a starting point. At this stage some pinned versions can be shifted, e.g. updating python to the latest release.

??? info "Generating `0-desy-pinned.yml`"

    To update/generate a new `0-desy-pinned.yml` file run:

    ```bash
    /gpfs/exfel/sw/software/euxfel-environment-management/scripts/utility.py dump
    ```

Otherwise create a standard Conda environment file defining the channels and the dependencies you require:

!!! info inline end

    If the environment is likely to be used as a Jupyter kernel on Max-JHub then you need to take care to have the same versions of a few packages, see [Interactive Plotting Issues in Jupyter Notebooks](#interactive-plotting-issues-in-jupyter-notebooks). The `0-desy-lock.yml` file is intended to help prevent these issues.

```yaml
channels:
  - conda-forge
  - defaults
dependencies:
  - numpy  # for example
```

And place any dependencies under the `dependencies` section. Note that these are **Conda dependencies**, from Conda channels, not from PyPI, so the package names may differ (see <https://anaconda.org/> to search through the official channels).

Once all required dependencies have been added to the dependencies list, carry on with the instructions in [Locking and Installing an Environment](#locking-and-installing-an-environment), as well as [Creating a Modulefile](#creating-a-modulefile).

### Modifying Existing Specifications

To add a new package to an existing environment, the package should be added to the `1-base.yml` if is is an existing package on a Conda channel, or added to `2-custom.yml` if it is a package where the recipe has to be created by us.

Once all required dependencies have been added to the dependencies list, carry on with the instructions in [Locking and Installing an Environment](#locking-and-installing-an-environment).

## Locking and Installing an Environment

First run `module load exfel mambaforge`, this will activate the conda installation that the environment will be created within.

Now, `cd` into the directory of the environment you are working on (e.g. `cd ./environments/202301`), and run the following command:

```bash
/gpfs/exfel/sw/software/euxfel-environment-management/scripts/utility.py merge
```

This will merge all of the individual environment files into a single `environment.yml` file which can then be used to create/update an environment.

The command will print off instructions on what to do next:

> Next steps:
>
> 1. Sync environment with new `environment.yml` file:
>
>     `mamba env update -n environments -f ./environment.yml`
>
> 2. After update is complete create a 'lock file' by running export:
>
>     `mamba env export -n environments --no-builds -f environment.lock.yml`
>
> 3. Add and commit any new or modified files, then push.

## Creating a Modulefile

If you are updating an environment, the modulefile does not require changes. If you've created a new environment, you need to create a module file for it so that users can easily activate it.

There are a few ways to create a module file which enables a conda environment:

1. Prepend to `PATH` to make user commands call the `python` executable in the environment. This is the most basic approach, but can fail if more environment variables have to be adjusted, and this will cause `conda` commands to fail.

    ??? note "Example module file"

        ```tcl
        #%Module 1.0
        proc ModulesHelp {} {
            puts stdout    "Mamba environment for cycle 202301"
        }

        module-whatis  "Module loads the mamba environment for cycle 202301"

        prepend-path    PATH /gpfs/exfel/sw/software/mambaforge/22.11/envs/202301/bin
        setenv      CONDA_DEFAULT_ENV 202301
        setenv      CONDA_PREFIX /gpfs/exfel/sw/software/mambaforge/22.11/envs/202301
        setenv      CONDA_PROMPT_MODIFIER {(202301) }
        setenv      CONDA_SHLVL 1
        setenv      GSETTINGS_SCHEMA_DIR /gpfs/exfel/sw/software/mambaforge/22.11/envs/202301/share/glib-2.0/schemas
        setenv      GSETTINGS_SCHEMA_DIR_CONDA_BACKUP {}
        ```

2. Use `system` calls to directly call `conda activate ...;` in the user shell. This works as well as normally calling the activate commands, but can cause large amounts of latency due to the activate command accessing a lot of files.

    ??? note "Example module file"

        ```tcl
        #%Module 1.0
        proc ModulesHelp {} {
            puts stdout    "Mamba environment for cycle 202301"
        }

        module-whatis  "Module loads the mamba environment for cycle 202301"

        module load mambaforge

        # NOTE: the final semicolon is required
        puts stdout "mamba activate 202301;"
        ```

3. Use `module sh-to-mod` to convert a shell script to module file. This is the best approach - it works as well as the activate commands but without the additional latency.

The `sh-to-mod` approach requires writing a basic script which sets up the environment as you require it, you can then use the `sh-to-mod` command to automatically create a module file which will apply the required modifications to the environment.

For example the following script initialises `mamba` and then activates the `202301` environment:

```bash
#!/bin/zsh -l

source /gpfs/exfel/sw/software/mambaforge/22.11/bin/mamba-init

mamba activate 202301
```

Now by calling `sh-to-mod` you can convert this script into a module file:

```bash
module sh-to-mod bash ./script.sh
```

Which creates the following module file:

```tcl
#%Module 1.0
prepend-path    PATH /gpfs/exfel/sw/software/mambaforge/22.11/envs/202301/bin
setenv      CONDA_DEFAULT_ENV 202301
setenv      CONDA_PREFIX /gpfs/exfel/sw/software/mambaforge/22.11/envs/202301
setenv      CONDA_PROMPT_MODIFIER {(202301) }
setenv      CONDA_SHLVL 1
setenv      GSETTINGS_SCHEMA_DIR /gpfs/exfel/sw/software/mambaforge/22.11/envs/202301/share/glib-2.0/schemas
setenv      GSETTINGS_SCHEMA_DIR_CONDA_BACKUP {}
set-function    __conda_activate {
    if [ -n "${CONDA_PS1_BACKUP:+x}" ]; then
        PS1="$CONDA_PS1_BACKUP";
        \unset CONDA_PS1_BACKUP;
    fi;
    \local ask_conda;
    ask_conda="$(PS1="${PS1:-}" __conda_exe shell.posix "$@")" || \return;
    \eval "$ask_conda";
    __conda_hashr}
set-function    __conda_exe {
    ( "$CONDA_EXE" $_CE_M $_CE_CONDA "$@" )}
set-function    __conda_hashr {
    if [ -n "${ZSH_VERSION:+x}" ]; then
        \rehash;
    else
        if [ -n "${POSH_VERSION:+x}" ]; then
            :;
        else
            \hash -r;
        fi;
    fi}
set-function    __conda_reactivate {
    \local ask_conda;
    ask_conda="$(PS1="${PS1:-}" __conda_exe shell.posix reactivate)" || \return;
    \eval "$ask_conda";
    __conda_hashr}
set-function    __mamba_exe {
    ( \local MAMBA_CONDA_EXE_BACKUP=$CONDA_EXE;
    \local MAMBA_EXE=$(\dirname "${CONDA_EXE}")/mamba;
    "$MAMBA_EXE" $_CE_M $_CE_CONDA "$@" )}
set-function    conda {
    \local cmd="${1-__missing__}";
    case "$cmd" in
        activate | deactivate)
            __conda_activate "$@"
        ;;
        install | update | upgrade | remove | uninstall)
            __conda_exe "$@" || \return;
            __conda_reactivate
        ;;
        *)
            __conda_exe "$@"
        ;;
    esac}
set-function    mamba {
    \local cmd="${1-__missing__}";
    case "$cmd" in
        activate | deactivate)
            __conda_activate "$@"
        ;;
        install | update | upgrade | remove | uninstall)
            __mamba_exe "$@" || \return;
            __conda_reactivate
        ;;
        *)
            __mamba_exe "$@"
        ;;
    esac}
```

A few modifications should be made to this:

1. Add help and description:

    ```tcl
    proc ModulesHelp {} {
        puts stdout    "Mamba environment for cycle 202301"
    }

    module-whatis  "Module loads the mamba environment for cycle 202301"
    ```

2. Add a call to the `metrics.sh` script which tracks module activations:

    ```tcl
    if { [ module-info mode load ] } {
        system    "/gpfs/exfel/sw/software/local/etc/metrics.sh 'mamba/202301'"
    }
    ```

3. Optionally, create scripts for other shells (`konsh`, `fish`) and use a switch case to support them:

    ```tcl
    switch -- [module-info shelltype] {
            sh {
              ...
            }
            fish {
              ...
            }
    ```

!!! note

    Some module files may contain an additional guard case:

    ```tcl
    if {[info commands set-function] eq {set-function}} {
      ...
    }
    ```

    This checks if a command (in this case `set-function`) exists, it was required as the default module version on Maxwell was very old and did not support some functions like setting shell functions.

    Now that environment modules was updated this is no longer required, but may still be present in some files.

After all of this you can end up with a rather large and complex module file, however  keep in mind that 99% of it was generated by the `sh-to-mod` command. For example here is the module file for the `202301` environment, which has both `sh` and `fish` support and the guard for `set-function` being present:

??? example

    ```tcl
    #%Module 1.0
    proc ModulesHelp {} {
        puts stdout    "Mamba environment for cycle 202301"
    }

    module-whatis  "Module loads the mamba environment for cycle 202301"

    if { [ module-info mode load ] } {
        system    "/gpfs/exfel/sw/software/local/etc/metrics.sh 'mamba/202301'"
        puts stderr "Default module version changed from 1.1.2 to 202301"
        puts stderr "Use `module load exfel_anaconda3/1.1.2` to revert to previous version if required"
        puts stderr "For more information on the new approach to environment management see the documentation here: https://european-xfel.github.io/environments/"
    }

    prepend-path    PATH /gpfs/exfel/sw/software/mambaforge/22.11/envs/202301/bin
    setenv      CONDA_DEFAULT_ENV 202301
    setenv      CONDA_PREFIX /gpfs/exfel/sw/software/mambaforge/22.11/envs/202301
    setenv      CONDA_PROMPT_MODIFIER {(202301) }
    setenv      CONDA_SHLVL 1
    setenv      GSETTINGS_SCHEMA_DIR /gpfs/exfel/sw/software/mambaforge/22.11/envs/202301/share/glib-2.0/schemas
    setenv      GSETTINGS_SCHEMA_DIR_CONDA_BACKUP {}

    if {[info commands set-function] eq {set-function}} {
        switch -- [module-info shelltype] {
            sh {
                set-function    __conda_activate {
                    if [ -n "${CONDA_PS1_BACKUP:+x}" ]; then
                        PS1="$CONDA_PS1_BACKUP";
                        \unset CONDA_PS1_BACKUP;
                    fi;
                    \local ask_conda;
                    ask_conda="$(PS1="${PS1:-}" __conda_exe shell.posix "$@")" || \return;
                    \eval "$ask_conda";
                    __conda_hashr}
                set-function    __conda_exe {
                    ( "$CONDA_EXE" $_CE_M $_CE_CONDA "$@" )}
                set-function    __conda_hashr {
                    if [ -n "${ZSH_VERSION:+x}" ]; then
                        \rehash;
                    else
                        if [ -n "${POSH_VERSION:+x}" ]; then
                            :;
                        else
                            \hash -r;
                        fi;
                    fi}
                set-function    __conda_reactivate {
                    \local ask_conda;
                    ask_conda="$(PS1="${PS1:-}" __conda_exe shell.posix reactivate)" || \return;
                    \eval "$ask_conda";
                    __conda_hashr}
                set-function    __mamba_exe {
                    ( \local MAMBA_CONDA_EXE_BACKUP=$CONDA_EXE;
                    \local MAMBA_EXE=$(\dirname "${CONDA_EXE}")/mamba;
                    "$MAMBA_EXE" $_CE_M $_CE_CONDA "$@" )}
                set-function    conda {
                    \local cmd="${1-__missing__}";
                    case "$cmd" in
                        activate | deactivate)
                            __conda_activate "$@"
                        ;;
                        install | update | upgrade | remove | uninstall)
                            __conda_exe "$@" || \return;
                            __conda_reactivate
                        ;;
                        *)
                            __conda_exe "$@"
                        ;;
                    esac}
                set-function    mamba {
                    \local cmd="${1-__missing__}";
                    case "$cmd" in
                        activate | deactivate)
                            __conda_activate "$@"
                        ;;
                        install | update | upgrade | remove | uninstall)
                            __mamba_exe "$@" || \return;
                            __conda_reactivate
                        ;;
                        *)
                            __mamba_exe "$@"
                        ;;
                    esac}
            }
            fish {
                complete    fish conda {--no-files -a '(__fish_conda_commands)' -n __fish_conda_needs_command}
                complete    fish conda {--no-files -a '(__fish_conda_env_commands)' -n '__fish_conda_using_command env'}
                complete    fish conda {--no-files -a '(__fish_conda_envs)' -n '__fish_conda_using_command activate'}
                complete    fish conda {--no-files -a '(__fish_conda_packages)' -n '__fish_conda_using_command remove'}
                complete    fish conda {--no-files -a '(__fish_conda_packages)' -n '__fish_conda_using_command uninstall'}
                complete    fish conda {--no-files -a '(__fish_conda_packages)' -n '__fish_conda_using_command update'}
                complete    fish conda {--no-files -a '(__fish_conda_packages)' -n '__fish_conda_using_command upgrade'}
                set-function    __conda_add_prompt {
                    if set -q CONDA_PROMPT_MODIFIER
                        set_color -o green
                        echo -n $CONDA_PROMPT_MODIFIER
                        set_color normal
                    end}
                set-function    __fish_conda_commands {
                    string replace -r '.*_([a-z]+)\.py$' '$1' $_CONDA_ROOT/lib/python*/site-packages/conda/cli/main_*.py
                    for f in $_CONDA_ROOT/bin/conda-*
                        if test -x "$f" -a ! -d "$f"
                            string replace -r '^.*/conda-' '' "$f"
                        end
                    end
                    echo activate
                    echo deactivate}
                set-function    __fish_conda_env_commands {
                    string replace -r '.*_([a-z]+)\.py$' '$1' $_CONDA_ROOT/lib/python*/site-packages/conda_env/cli/main_*.py}
                set-function    __fish_conda_envs {
                    conda config --json --show envs_dirs | python -c "import json, os, sys; from os.path import isdir, join; print('\n'.join(d for ed in json.load(sys.stdin)['envs_dirs'] if isdir(ed) for d in os.listdir(ed) if isdir(join(ed, d))))"}
                set-function    __fish_conda_needs_command {
                    set cmd (commandline -opc)
                    if [ (count $cmd) -eq 1 -a $cmd[1] = conda ]
                        return 0
                    end
                    return 1}
                set-function    __fish_conda_packages {
                    conda list | awk 'NR > 3 {print $1}'}
                set-function    __fish_conda_using_command {
                    set cmd (commandline -opc)
                    if [ (count $cmd) -gt 1 ]
                        if [ $argv[1] = $cmd[2] ]
                            return 0
                        end
                    end
                    return 1}
                set-function    __fish_prompt_orig {
                }
                set-function    __fish_right_prompt_orig {
                    }
                set-function    conda {
                    set -l CONDA_EXE /gpfs/exfel/sw/software/mambaforge/22.11/bin/conda
                    if [ (count $argv) -lt 1 ]
                        $CONDA_EXE
                    else
                        set -l cmd $argv[1]
                        set -e argv[1]
                        switch $cmd
                            case activate deactivate
                                eval ($CONDA_EXE shell.fish $cmd $argv)
                            case install update upgrade remove uninstall
                                $CONDA_EXE $cmd $argv
                                and eval ($CONDA_EXE shell.fish reactivate)
                            case '*'
                                $CONDA_EXE $cmd $argv
                        end
                    end}
                set-function    return_last_status {
                    return $argv}
            }
        }
    }
    ```

### Setting a Default Modulefile

To set a default modulefile, go to the directory the modulefile is in (for cycle environments that would be `/gpfs/exfel/sw/software/xfel_modules/mamba`) and create a file called `.version` containing:

```tcl
#%Module1.0
set ModulesVersion "{NEW_CYCLE_NUMBER}"
```

This will set the default for that directory to the new cycle number.

## Creating a Kernel for Max-JHub

The following directory contains kernels which are automatically on the kernel list on Max-JHub:

```shell
/gpfs/exfel/sw/software/local/share/jupyter/kernels
```

To add a new kernel, create a new directory in this location with the name of the kernel, and then create a `kernel.json` file in that directory with the following contents:

```json
{
  "argv": [
    "${PYTHON_PATH}",
    "-m",
    "ipykernel_launcher",
    "-f",
    "{connection_file}"
  ],
  "display_name": "xfel (202301)",
  "language": "python"
}
```

The `display_name` is what will be displayed in the Max-JHub kernel list, this should be descriptive and (if for a cycle environment) include the cycle number.

Replace `${PYTHON_PATH}` with the path to the python executable for the environment, this can be easily found by loading/activating the environment and running `which python`.

## FAQ

### Interactive Plotting Issues in Jupyter Notebooks

If an environment has issues with interactive plotting in Jupyter notebooks it is likely that the packages in it are out of sync with those in the environment running Jupyter/JupyterLab on Max-JHub.

The module used for Max-JHub is mentioned on the DESY documentation page here: <https://confluence.desy.de/display/MXW/JupyterHub+on+Maxwell>. Currently this is `conda/3.8`.

You should load that environment and then check the versions of the following packages:

- ipympl
- ipywidgets
- matplotlib

And pin them to be the same as the versions currently used by Max-JHub. Currently (February 2023) this means:

```text
- ipympl=0.7.0
- ipywidgets=7.6.3
- matplotlib=3.4.2
```
