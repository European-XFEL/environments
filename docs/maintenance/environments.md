# Environments

An environment is created per European XFEL experiment cycle, this is done so
that previous environments are preserved for reproducibility. The files defining
the environments are stored `./environments/${CYCLE}`.

Each environment directory will have two or three files:

- `base.yml` - Conda environment file containing packages which are available
  on a Conda channel
- `custom.yml` - optional Conda environment file containing packages built from
  custom recipes (see [Recipes](./recipes.md))
- `conda-lock.yml` - file generated by `conda-lock` using the environment files
  as inputs

Environments exist in an installation of Conda, setting up a new Conda
installation is very rarely required and is covered in the
[Installation](./installation.md) section.

## Creating a New Environment

The first step to creating a new environment is activating an installation, this
can be done with `module load exfel mambaforge`. Loading this module will
initialise the Conda instance into the `base` environment which provides
`grayskull` and `conda-lock` which are used to create the environments.

Once a Conda instance has been activated, you can create a new directory under
either `./environments/${CYCLE}` or
`./applications/${APPLICATION_NAME}/{APPLICATION_VERSION}` depending on whether
the environment is intended to be a generic environment users will activate to
write and execute their own code, or if the environment exists only to provide a
specific application.

If a new cycle environment is being created, copy the `base.yml` and
`custom.yml` files from the previous cycle, and use those as a starting point.

Otherwise create a standard Conda environment file defining the channels and the
dependencies you require:

```yaml
channels:
  - file://gpfs/exfel/sw/software/euxfel-environment-management/conda-bld
  - conda-forge
  - defaults
dependencies:
  - numpy  # for example
```

And place any dependencies under the `dependencies` section. Note that these are
Conda dependencies, from Conda channels, not from PyPI, so the package names may
differ.

Once all required dependencies have been added to the dependencies list, carry
on with the instructions in [Locking and Installing an Environment](#locking-and-installing-an-environment).

## Modifying an Existing Environment

To add a new package to an existing environment, the package should be added to
the `base.yml` if is is an existing package on a Conda channel, or added to
`custom.yml` if it is a package where the recipe has to be created by us.

Once all required dependencies have been added to the dependencies list, carry
on with the instructions in [Locking and Installing an Environment](#locking-and-installing-an-environment).

## Locking and Installing an Environment

The following command can be used to concretize the environment and update or
create `conda-lock.yml`:

```shell
conda-lock \
  -f base.yml \
  -f custom.yml \
  --lockfile conda-lock.yml \  # Only if updating an existing environment
  -p linux-64
```

If the locking completes successfully, you should **add and commit the file**
with a description of the changes made in the commit message. Then you can then
update/install the environment via:

```shell
conda-lock install --name ${ENV_NAME} ./conda-lock.yml
```
